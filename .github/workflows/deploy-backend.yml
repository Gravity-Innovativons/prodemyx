name: Deploy Backend to EC2

on:
  push:
    branches: ["main"]
    paths:
      - 'backend/**'
      - 'prodemyx.sql'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 2

    - name: Add SSH key
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: Setup MySQL Server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash -s' << 'EOF'
        set -e
        echo "========================================="
        echo "Setting up MySQL Server"
        echo "========================================="
        if ! command -v mysql > /dev/null 2>&1; then
          echo "Installing MySQL Server..."
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y mysql-server
          sudo systemctl enable mysql
          sudo systemctl start mysql
          echo "MySQL installed successfully"
        else
          echo "MySQL already installed"
          sudo systemctl start mysql || true
        fi
        echo "Configuring MySQL database..."
        sudo mysql -e "CREATE DATABASE IF NOT EXISTS prodemyx;" 2>/dev/null || true
        sudo mysql -e "CREATE USER IF NOT EXISTS 'prodemyx_user'@'localhost' IDENTIFIED BY 'ProdemyxSecure2024!';" 2>/dev/null || true
        sudo mysql -e "GRANT ALL PRIVILEGES ON prodemyx.* TO 'prodemyx_user'@'localhost';" 2>/dev/null || true
        sudo mysql -e "FLUSH PRIVILEGES;" 2>/dev/null || true
        echo "MySQL database configured"
        EOF

    - name: Setup Node.js and PM2
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash -s' << 'EOF'
        set -e
        echo "========================================="
        echo "Setting up Node.js and PM2"
        echo "========================================="
        if ! command -v node > /dev/null 2>&1; then
          echo "Installing Node.js 18.x..."
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          echo "Node.js installed: $(node -v)"
        else
          echo "Node.js already installed: $(node -v)"
        fi
        if ! command -v pm2 > /dev/null 2>&1; then
          echo "Installing PM2..."
          sudo npm install -g pm2
          echo "PM2 installed successfully"
        else
          echo "PM2 already installed"
        fi
        EOF

    - name: Setup Nginx
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash -s' << 'EOF'
        set -e
        echo "========================================="
        echo "Setting up Nginx"
        echo "========================================="
        if ! command -v nginx > /dev/null 2>&1; then
          echo "Installing Nginx..."
          sudo apt-get update
          sudo apt-get install -y nginx
          sudo systemctl enable nginx
          sudo systemctl start nginx
          echo "Nginx installed successfully"
        else
          echo "Nginx already installed"
          sudo systemctl start nginx || true
        fi
        EOF

    - name: Setup PHP and phpMyAdmin
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash -s' << 'EOF'
        set -e
        echo "========================================="
        echo "Setting up PHP and phpMyAdmin"
        echo "========================================="
        if ! command -v php > /dev/null 2>&1; then
          echo "Installing PHP and extensions..."
          sudo apt-get install -y php-fpm php-mysql php-mbstring php-zip php-gd php-json php-curl
          sudo systemctl enable php8.3-fpm
          sudo systemctl start php8.3-fpm
          echo "PHP installed: $(php -v | head -n 1)"
        else
          echo "PHP already installed: $(php -v | head -n 1)"
          sudo systemctl start php8.3-fpm || true
        fi
        if [ ! -d "/usr/share/phpmyadmin" ]; then
          echo "Installing phpMyAdmin..."
          cd /tmp
          wget -q https://www.phpmyadmin.net/downloads/phpMyAdmin-latest-all-languages.tar.gz
          tar xzf phpMyAdmin-latest-all-languages.tar.gz
          sudo mv phpMyAdmin-*-all-languages /usr/share/phpmyadmin
          sudo mkdir -p /usr/share/phpmyadmin/tmp
          sudo chown -R www-data:www-data /usr/share/phpmyadmin
          sudo chmod 777 /usr/share/phpmyadmin/tmp
          sudo cp /usr/share/phpmyadmin/config.sample.inc.php /usr/share/phpmyadmin/config.inc.php
          BLOWFISH_SECRET=$(openssl rand -base64 32)
          sudo sed -i "s/\$cfg\['blowfish_secret'\] = '';/\$cfg['blowfish_secret'] = '$BLOWFISH_SECRET';/" /usr/share/phpmyadmin/config.inc.php
          echo "phpMyAdmin installed successfully"
        else
          echo "phpMyAdmin already installed"
        fi
        EOF

    - name: Configure Firewall
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash -s' << 'EOF'
        echo "========================================="
        echo "Configuring Firewall"
        echo "========================================="
        if command -v ufw > /dev/null 2>&1; then
          sudo ufw allow 22/tcp || true
          sudo ufw allow 80/tcp || true
          sudo ufw allow 443/tcp || true
          sudo ufw allow 3000/tcp || true
          sudo ufw allow 5000/tcp || true
          sudo ufw --force enable || true
          echo "Firewall configured"
        fi
        echo "Setup completed successfully!"
        EOF

    - name: Create backend directory
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo mkdir -p /var/www/prodemyx-backend && sudo chown -R ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} /var/www/prodemyx-backend"

    - name: Check if database file changed
      id: check_db
      run: |
        if git diff --name-only HEAD^ HEAD | grep -q "prodemyx.sql"; then
          echo "db_changed=true" >> $GITHUB_OUTPUT
        else
          echo "db_changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Import database if SQL file changed
      if: steps.check_db.outputs.db_changed == 'true'
      run: |
        echo "Database file changed, importing..."
        scp -o StrictHostKeyChecking=no prodemyx.sql ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/prodemyx.sql
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash -s' << 'EOF'
        set -e
        echo "Creating database backup..."
        BACKUP_FILE="/tmp/prodemyx_backup_$(date +%Y%m%d_%H%M%S).sql"
        mysqldump -u prodemyx_user -pProdemyxSecure2024! prodemyx > "$BACKUP_FILE" 2>/dev/null || echo "No existing data to backup"
        echo "Importing database..."
        mysql -u prodemyx_user -pProdemyxSecure2024! prodemyx < /tmp/prodemyx.sql
        echo "Database imported successfully!"
        rm -f /tmp/prodemyx.sql
        EOF

    - name: Sync backend folder to EC2
      run: |
        rsync -avz --delete \
          --exclude 'node_modules' \
          --exclude '.git' \
          --exclude '.env' \
          --exclude 'logs/*' \
          --exclude '*.log' \
          -e 'ssh -o StrictHostKeyChecking=no' \
          backend/ \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/prodemyx-backend/

    - name: Deploy environment variables
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "cat > /var/www/prodemyx-backend/.env" << 'ENVEOF'
        PORT=5000
        PUBLIC_URL=http://${{ secrets.EC2_HOST }}
        ${{ secrets.BACKEND_ENV }}
        ENVEOF
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "chmod 600 /var/www/prodemyx-backend/.env"

    - name: Configure Nginx with all routes
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} bash << EOF
        echo "Configuring Nginx with all routes..."
        export DASHBOARD_PATH="${{ secrets.EC2_DASHBOARD_PATH }}"
        cat > /tmp/nginx-config << 'NGINXEOF'
        upstream backend_app {
            server 127.0.0.1:5000;
            keepalive 64;
        }

        server {
            listen 80;
            server_name _;
            
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            
            client_max_body_size 50M;
            
            location /api/api-docs {
                return 301 /api-docs;
            }

            location ^~ /api/ {
                proxy_pass http://backend_app;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_cache_bypass \$http_upgrade;
                proxy_read_timeout 300s;
                proxy_connect_timeout 75s;
            }
            
            location /api-docs {
                proxy_pass http://backend_app/api-docs;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_cache_bypass \$http_upgrade;
            }

            location /phpmyadmin {
                root /usr/share;
                index index.php index.html index.htm;
                location ~ ^/phpmyadmin/(.+\.php)\$ {
                    try_files \$uri =404;
                    root /usr/share;
                    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
                    fastcgi_index index.php;
                    fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
                    include fastcgi_params;
                }
                location ~* ^/phpmyadmin/(.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt))\$ {
                    root /usr/share;
                }
            }

            location /app/ {
                alias \${DASHBOARD_PATH}/;
                try_files \$uri \$uri/ /app/index.html;
                index index.html;
            }
            
            location / {
                root /var/www/prodemyx-website;
                try_files \$uri \$uri/ /index.html;
                index index.html;
            }
            
            location ~ /\. {
                deny all;
                access_log off;
                log_not_found off;
            }
        }
        NGINXEOF
        envsubst '\${DASHBOARD_PATH}' < /tmp/nginx-config | sudo tee /etc/nginx/sites-available/prodemyx-config > /dev/null
        sudo ln -sf /etc/nginx/sites-available/prodemyx-config /etc/nginx/sites-enabled/prodemyx-config
        sudo rm -f /etc/nginx/sites-enabled/default
        sudo nginx -t
        sudo systemctl restart nginx
        echo "Nginx configured successfully!"
        EOF

    - name: Install dependencies and restart backend
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash -s' << 'EOF'
        set -e
        cd /var/www/prodemyx-backend
        echo "Installing dependencies..."
        npm install --legacy-peer-deps
        echo "Managing PM2 process..."
        
        # Stop any existing process to be safe
        pm2 delete prodemyx-backend 2>/dev/null || true
        
        echo "Starting new backend process using npm start..."
        pm2 start npm --name prodemyx-backend -- run start -- --port=5000
        sleep 10 # Give the backend some time to start up
        curl -f http://localhost:5000/api-docs || (echo "Backend health check failed!"; exit 1)
        pm2 save
        echo "Backend deployment completed!"
        EOF

    - name: Verify deployment
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash -s' << 'EOF'
        echo "========================================="
        echo "Deployment Verification"
        echo "========================================="
        echo "Checking backend process..."
        pm2 list | grep prodemyx-backend || exit 1
        echo "Checking MySQL..."
        sudo systemctl is-active mysql || exit 1
        echo "Checking Nginx..."
        sudo systemctl is-active nginx || exit 1
        echo "Checking PHP-FPM..."
        sudo systemctl is-active php8.3-fpm || echo "Warning: PHP-FPM not active (phpMyAdmin may not work)"
        echo "Testing backend API..."
        sleep 3
        curl -f http://localhost:5000 > /dev/null 2>&1 || echo "Backend warming up..."
        echo "========================================="
        echo "âœ“ Backend deployment successful!"
        echo "========================================="
        echo "Services running:"
        echo "  - MySQL: Active"
        echo "  - Node.js Backend: Active (PM2)"
        echo "  - Nginx: Active"
        echo "  - PHP-FPM: $(sudo systemctl is-active php8.3-fpm 2>/dev/null || echo 'Inactive')"
        echo "  - phpMyAdmin: Available at /phpmyadmin"
        echo "  - Swagger Docs: Available at /api-docs"
        echo "========================================="
        EOF
        