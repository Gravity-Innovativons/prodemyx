name: Deploy Dashboard to EC2

on:
  push:
    branches: [ "main" ]
    paths:
      - 'dashboard/**'
      - '.github/workflows/deploy-dashboard.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        # UPGRADE NODE: Changed from '18' to '20' to satisfy Vite's requirement.
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: dashboard/package-lock.json

    - name: Install dependencies
      run: |
        cd dashboard
        # CHANGED TO npm ci: 'npm ci' performs a clean install which is more reliable 
        # for resolving all nested dependencies (like 'react-is').
        npm ci

    - name: Build dashboard
      env:
        VITE_API_URL: ${{ secrets.VITE_API_URL }}
      run: |
        cd dashboard
        npm run build

    - name: Add SSH key
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: |
          ${{ secrets.EC2_SSH_KEY }}

    - name: Debug host
      run: echo "Host='${{ secrets.EC2_HOST }}' User='${{ secrets.EC2_USER }}'"

    - name: Create dashboard directory on EC2
      run: |
        ssh -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "sudo mkdir -p '${{ secrets.EC2_FRONTEND_PATH }}' && sudo chown -R ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} '${{ secrets.EC2_FRONTEND_PATH }}'"

    - name: Deploy build to EC2
      run: |
        rsync -avz --delete \
          -e 'ssh -o StrictHostKeyChecking=no' \
          dashboard/dist/ \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:'${{ secrets.EC2_FRONTEND_PATH }}/'

    - name: Set correct permissions
      run: |
        ssh -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "sudo chown -R www-data:www-data '${{ secrets.EC2_FRONTEND_PATH }}' && sudo chmod -R 755 '${{ secrets.EC2_FRONTEND_PATH }}'"

    - name: Ensure Nginx is installed
      run: |
        ssh -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "if ! command -v nginx >/dev/null 2>&1; then \
              echo 'Nginx not found. Installing...'; \
              sudo apt update && sudo apt install nginx -y; \
              sudo systemctl enable nginx; \
              sudo systemctl start nginx; \
           else \
              echo 'Nginx already installed'; \
           fi"
           
    - name: Deploy Nginx Configuration
      env:
        PRODEMYX_PATH: ${{ secrets.EC2_PRODEMYX_PATH }}
        FRONTEND_PATH: ${{ secrets.EC2_FRONTEND_PATH }}
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "bash -s" <<'EOF'
        
        # Define the configuration content using a variable to simplify quoting
        CONFIG_CONTENT="
        upstream backend_app {
            server 127.0.0.1:3000;
        }

        server {
            listen 80;
            server_name _;

            # 1. PROXY API REQUESTS TO BACKEND (Port 3000)
            location /api/ {
                rewrite ^/api/(.*)$ /$1 break;
                proxy_pass http://backend_app;
                proxy_http_version 1.1;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host \$host;
                proxy_cache_bypass \$http_upgrade;
            }

            # 2. SERVE MAIN WEBSITE (Prodemyx)
            location / {
                root $PRODEMYX_PATH;
                index index.html index.htm;
                try_files \$uri \$uri/ /index.html;
            }
            
            # 3. SERVE SECONDARY FRONTEND APPLICATION
            location /app/ {
                alias $FRONTEND_PATH/;
                try_files \$uri \$uri/ @frontend_rewrite;
            }
            
            location @frontend_rewrite {
                rewrite ^/app/(.*)$ /app/index.html break;
            }
        }
        "
        
        # Write the configuration file
        echo "\$CONFIG_CONTENT" | sudo tee /etc/nginx/sites-available/prodemyx-config
        
        # Create symbolic link and remove default config if they exist
        if [ ! -L /etc/nginx/sites-enabled/prodemyx-config ]; then
          sudo ln -s /etc/nginx/sites-available/prodemyx-config /etc/nginx/sites-enabled/
        fi
        if [ -L /etc/nginx/sites-enabled/default ]; then
          sudo rm /etc/nginx/sites-enabled/default
        fi
        
        EOF

    - name: Reload Nginx
      run: |
        ssh -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
          "sudo /usr/sbin/nginx -t && sudo systemctl reload nginx && echo 'Dashboard deployment successful!'"